## Section 1.5 多表关系
### 1. 多表关系
项目开发中，在进行数据库表结构设计时，会根据业务需求以及业务模块之间的关系，分析并设计表结构，由于业务之间相互关联，所以各个表结构之间也存在着各种联系，主要分为：一对一，多对一（一对多）和多对多几种多表关系。

- 多对一（一对多）： 在考虑部门和员工关系时，一个部门可以对应多个员工，一个员工只对应一个部门。此时，**选择在多的一方建立外键，指向一的一方的主键**。
- 多对多： 在考虑学生与课程的关系时，一个学生可以选修多门课程，一门课程也可供多个学生选择。此时，**建立第三张中间表，中间表至少包含两个外键，分别关联两方主键**。
- 一对一： 一对一的关系主要用于单表拆分，将一张表的基础字段放在一张表中，将其他详情字段放在另一张表中，以提高操作效率。此时，**在任意一方加入主键，关联另外一方的主键，并设置外键为唯一的（unique）**。

### 2.多表查询
**概念**
**分类**
- 连接查询
     - 内连接：相当于查询左表和右表交集部分数据；
     - 外连接：
         - 左外连接：查询左表的所有信息以及左表和右表交集部分数据；
         - 右外连接：查询右表的所有信息以及左表和右表交集部分数据；
     - 自连接：查询一张表的所有数据；
- 子查询


###  3.内连接
- 隐式内连接
```sql
select 字段列表 from 表1,表2 where 条件...;
```

- 显式内连接
```sql
select 字段列表 from 表1 [inner] join 表2 on 连接条件...;
```

思考：为什么需要两种内连接的方式？

### 4.外连接
**左外连接**：查询表1（左表）的所有数据，包含表1和表2交集部分的数据
```sql
select 字段列表 from 表1 left [outer] join 表2 on 条件...;
```

**右外连接**：查询表2（右表）的所有数据，包含表1和表2交集部分的数据
```sql
select 字段列表 from 表1 right [outer] join 表2 on 条件...;
```

### 5.自连接
**自连接查询语法**
```sql
select 字段列表 from 表A 别名A join 表A 别名B on 条件...;
```
自连接可以是内连接也可以是外连接。

自连接时要给表其两个别名。

### 6.联合查询
对于union 查询，就是要把多次查询的结果合并起来，形成一个新的查询结果集；

```sql
select 字段列表 from 表A...
union [all]
select 字段列表 from 表B...
```

注意：这里union all会直接合并所有查询结果，union会删除重复项。

### 7.子查询
**概念**：SQL语句中嵌套select语句，称为嵌套查询，又称为子查询。
```sql
select * from t1 where column1 = (Select column1 from t2);
```
**分类**
- 根据子查询结果不同我们可以将其又分为：
   - **标量子查询**：子查询返回的结果是单个值（数字，字符串，日期等等），最简单的形式，这种子查询称为标量子查询。
   - **列子查询**：子查询返回的结果是一列，常见操作有：in，not in，any，some，all；
        | 操作符 | 描述 |
        | :---:  | :---: |

   - **行子查询**：子查询返回的结果是一行（可以是多列）， 常见操作有：=，！=，in，not in；
   - **表子查询**：子查询返回的结果是多行多列，常见操作为in；
- 根据子查询位置可以将其分为：**where之后，from之后，select之后**。


## Section 1.6 事务
### 1.事物简介
事物是一组操作的集合，是一个不可分割的工作单位，事物会把所有的操作作为一个整体一起向系统提交或撤销操作请求，这些操作**要么同时成功，要么同时失败**。

### 2.事务操作
**查看/设置事务提交方式**

```sql
select @@autocommit;
-- 设置为手动提交
set @@autocommit = 0; 
```

**提交事务**

```sql
commit;
```

**回滚事务**

```sql
rollback;
```

**开启事务**

```sql
start transaction 或者 begin
```

### 3.事务的四大特性（ACID)
- 原子性(Atomicity)：事务是不可分割的最小操作单元，要么全部执行成功，要么全部失败；
- 一致性(Consistency)：事务完成时，必须使所有的数据都保持一致状态；
- 隔离性(isolation)： 数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行；
- 持久性(Durability)：事务一旦提交或者回滚，它对数据库中的数据的改变就是永久的；

### 4.并发事务问题
| 问题 | 描述 |
| :---: | :---: |
|脏读| 一个事务读到另外一个事务还没有提交的数据|
|不可重复读| 一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读|
|幻读|一个事务按照条件查询数据时，没有对应的数据行，但在插入数据时，有发现这行数据已经存在，好像出现了“幻影”|

### 5.事务的隔离级别
**事务隔离级别**
|隔离级别        |脏读   |不可重复读|幻读|
| :---:          | :---: | :---: | :---: |
|read uncommitted|有|有|有|
|read committed  |无|有|有|
|repeatable read |无|无|有|
|serializable    |无|无|无|

从上往下，隔离级别越来越高，数据安全性越来越高，但是性能越来越差。其中serialization隔离级别最高，此时对于一个数据库只能有一个事务在操作，不能多个事务并发。

**查看事务隔离级别**
```sql
select @@transaction_isolation;
```

**设置事务的隔离级别**
```sql
set [session|global] transaction isolation level [read uncommitted|read committed|repeatable read|serializable]
```
